{% extends "analysis/base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}Stock Analysis{% endblock %}

{% block content %}
<div class="content-wrapper" data-symbol="{{ symbol }}">
    <h1>Stock Data for {{ symbol }}</h1>

    <div class="main-content">

        <div class="left-half">
            {% if user.is_authenticated %}
            {% if in_watchlist %}
                <form method="post" action="{% url 'remove_from_watchlist_from_stock' %}">
                    {% csrf_token %}
                    <input type="hidden" name="symbol" value="{{ symbol }}">
                    <button type="submit">Remove from Watchlist</button>
                </form>
            {% else %}
                <form method="post" action="{% url 'add_to_watchlist_from_stock' %}">
                    {% csrf_token %}
                    <input type="hidden" name="symbol" value="{{ symbol }}">
                    <input type="hidden" name="name" value="{{ stock_name }}">
                    <button type="submit">Add to Watchlist</button>
                </form>
            {% endif %}
            {% endif %}
            <div style="max-width: 100%; height: 400px;">
                <div style="z-index: -1;" id="chart"></div>
            </div>
        </div>

        <div class="right-half">
            <div id="company-overview">
                <div id="company-overview-grid"></div>
            </div>
        </div>

    </div>

    <div class="toggle-container">
        <label for="toggle-data">Select Data Type:</label>
        <select id="toggle-data">
            <option value="annual">Annual</option>
            <option value="quarterly">Quarterly</option>
        </select>
    </div>

    <div class="accordion">
        <div class="accordion-item">
            <button id="button-income-statement" class="accordion-button" aria-expanded="false" aria-controls="content-income-statement">
                Income Statement
                <span class="icon" aria-hidden="true"></span>
            </button>
            <div id="content-income-statement" class="accordion-content">
                <div class="column-toggles" id="income-statement-toggles"></div>
                <div id="income-statement-grid"></div>
            </div>
        </div>
        <div class="accordion-item">
            <button id="button-balance-sheet" class="accordion-button" aria-expanded="false" aria-controls="content-balance-sheet">
                Balance Sheet
                <span class="icon" aria-hidden="true"></span>
            </button>
            <div id="content-balance-sheet" class="accordion-content">
                <div class="column-toggles" id="balance-sheet-toggles"></div>
                <div id="balance-sheet-grid"></div>
            </div>
        </div>
        <div class="accordion-item">
            <button id="button-cash-flow" class="accordion-button" aria-expanded="false" aria-controls="content-cash-flow">
                Cash Flow
                <span class="icon" aria-hidden="true"></span>
            </button>
            <div id="content-cash-flow" class="accordion-content">
                <div class="column-toggles" id="cash-flow-toggles"></div>
                <div id="cash-flow-grid"></div>
            </div>
        </div>
        <div class="accordion-item">
            <button id="button-earnings" class="accordion-button" aria-expanded="false" aria-controls="content-earnings">
                Earnings
                <span class="icon" aria-hidden="true"></span>
            </button>
            <div id="content-earnings" class="accordion-content">
                <div class="column-toggles" id="earnings-toggles"></div>
                <div id="earnings-chart" style="max-height: 400px;"></div>
            </div>
        </div>
    </div>
</div>
<h2>News</h2>
<div class="news-section">
    {% for news in news_data %}
        <div class="news-item" style="background-image: url('{{ news.banner_image }}');">
            <div class="news-content">
                <p><strong>Source:</strong> {{ news.source }}</p>
                <h3><a href="{{ news.url }}" target="_blank">{{ news.title }}</a></h3>
                <p>{{ news.summary }}</p>
                <div class="sentiment">
                    <span class="sentiment-label">Sentiment: </span>
                    <span class="sentiment-tag {{ news.overall_sentiment_label|lower }}">
                        {{ news.overall_sentiment_label }}
                    </span>
                </div>
            </div>
        </div>
    {% endfor %}
</div>


<!-- Embed JSON data using script tags -->
<script type="application/json" id="time_series_data">{{ time_series|escapejs }}</script>
<script type="application/json" id="fundamental_data">{{ fundamental_data|escapejs }}</script>

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script src="https://cdn.jsdelivr.net/npm/gridjs/dist/gridjs.umd.js"></script>
<script src="{% static 'js/stocks.js' %}"></script>
<link href="https://cdn.jsdelivr.net/npm/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
<style>
    .accordion-button {
        width: 100%;
        text-align: left;
        background-color: #f1f1f1;
        border: none;
        outline: none;
        padding: 18px;
        font-size: 15px;
        transition: 0.4s;
        cursor: pointer;
        display: block;
        border-bottom: 1px solid #ddd;
        border-radius: 0; /* Remove rounding */
    }

    .accordion-button:hover,
    .accordion-button:focus {
        background-color: #ccc;
    }

    .accordion-content {
        display: none;
        padding: 18px;
        background-color: white;
        border-top: none;
        overflow: hidden;
    }

    .toggle-container {
        margin-bottom: 20px;
    }

    .column-toggles {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 10px;
    }

    .column-toggles .toggle {
        display: flex;
        align-items: center;
    }

    .column-toggles label {
        margin-left: 5px;
    }

    .main-content {
        display: flex;
        justify-content: space-between;
    }

    .left-half {
        width: 48%;
    }

    .right-half {
        width: 48%;
    }

    #company-overview {
        max-height: 400px;
        overflow-y: auto;
        overflow-x: hidden;
    }

    #chart, #earnings-chart {
        max-height: 500px;
    }

    .gridjs-container {
        font-size: 12px;
    }

    .gridjs-header .gridjs-th {
        white-space: nowrap;
    }

    .gridjs-td {
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
        max-width: 150px;
    }
</style>
{% endblock %}
