{% extends "analysis/base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}Stock Analysis{% endblock %}

{% block content %}
<div class="content-wrapper" data-symbol="{{ symbol }}">
    <h1>Stock Data for {{ symbol }}</h1>

    <div class="main-content">

        <div class="left-half">
            {% if user.is_authenticated %}
            {% if in_watchlist %}
                <form method="post" action="{% url 'remove_from_watchlist_from_stock' %}">
                    {% csrf_token %}
                    <input type="hidden" name="symbol" value="{{ symbol }}">
                    <button type="submit">Remove from Watchlist</button>
                </form>
            {% else %}
                <form method="post" action="{% url 'add_to_watchlist_from_stock' %}">
                    {% csrf_token %}
                    <input type="hidden" name="symbol" value="{{ symbol }}">
                    <input type="hidden" name="name" value="{{ stock_name }}">
                    <button type="submit">Add to Watchlist</button>
                </form>
            {% endif %}
            {% endif %}
            <div style="max-width: 100%; height: 400px;">
                <div id="chart"></div>
            </div>
            <form method="get" action="{% url 'stock_view' symbol=symbol %}">
                <label for="interval">Choose time interval:</label>
                <select name="interval" id="interval" onchange="this.form.submit()">
                    <option value="1min" {% if interval == '1min' %}selected{% endif %}>1min</option>
                    <option value="5min" {% if interval == '5min' %}selected{% endif %}>5min</option>
                    <option value="15min" {% if interval == '15min' %}selected{% endif %}>15min</option>
                    <option value="30min" {% if interval == '30min' %}selected{% endif %}>30min</option>
                    <option value="60min" {% if interval == '60min' %}selected{% endif %}>60min</option>
                    <option value="daily" {% if interval == 'daily' %}selected{% endif %}>Daily</option>
                    <option value="weekly" {% if interval == 'weekly' %}selected{% endif %}>Weekly</option>
                    <option value="monthly" {% if interval == 'monthly' %}selected{% endif %}>Monthly</option>
                </select>
            </form>
        </div>

        <div class="right-half">
            <div id="company-overview">
                <table id="table-company-overview"></table>
            </div>
        </div>

    </div>

    <div class="toggle-container">
        <label for="toggle-data">Select Data Type:</label>
        <select id="toggle-data">
            <option value="annual">Annual</option>
            <option value="quarterly">Quarterly</option>
        </select>
    </div>

    <div class="accordion">
        <div class="accordion-item">
            <button id="button-income-statement" class="accordion-button" aria-expanded="false" aria-controls="content-income-statement">
                Income Statement
                <span class="icon" aria-hidden="true"></span>
            </button>
            <div id="content-income-statement" class="accordion-content">
                <div class="column-toggles" id="income-statement-toggles"></div>
                <table id="table-income-statement"></table>
            </div>
        </div>
        <div class="accordion-item">
            <button id="button-balance-sheet" class="accordion-button" aria-expanded="false" aria-controls="content-balance-sheet">
                Balance Sheet
                <span class="icon" aria-hidden="true"></span>
            </button>
            <div id="content-balance-sheet" class="accordion-content">
                <div class="column-toggles" id="balance-sheet-toggles"></div>
                <table id="table-balance-sheet"></table>
            </div>
        </div>
        <div class="accordion-item">
            <button id="button-cash-flow" class="accordion-button" aria-expanded="false" aria-controls="content-cash-flow">
                Cash Flow
                <span class="icon" aria-hidden="true"></span>
            </button>
            <div id="content-cash-flow" class="accordion-content">
                <div class="column-toggles" id="cash-flow-toggles"></div>
                <table id="table-cash-flow"></table>
            </div>
        </div>
        <div class="accordion-item">
            <button id="button-earnings" class="accordion-button" aria-expanded="false" aria-controls="content-earnings">
                Earnings
                <span class="icon" aria-hidden="true"></span>
            </button>
            <div id="content-earnings" class="accordion-content">
                <div class="column-toggles" id="earnings-toggles"></div>
                <div id="earnings-chart" style="max-height: 400px;"></div>
            </div>
        </div>
    </div>

    <h2>News</h2>
    <div class="news-section">
        {% for news in news_data %}
            <div class="news-item">
                {% if news.banner_image %}
                <img src="{{ news.banner_image }}" alt="{{ news.title }}" style="max-width:100%;">
                {% endif %}
                <h3><a href="{{ news.url }}" target="_blank">{{ news.title }}</a></h3>
                <p><strong>Source:</strong> {{ news.source }}</p>
                <p>{{ news.summary }}</p>
                <div class="sentiment">
                    <span class="sentiment-label">Sentiment: </span>
                    <span class="sentiment-tag {{ news.overall_sentiment_label|lower }}">
                        {{ news.overall_sentiment_label }}
                    </span>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<!-- Embed JSON data using script tags -->
<script type="application/json" id="time_series_data">{{ time_series|escapejs }}</script>
<script type="application/json" id="fundamental_data">{{ fundamental_data|escapejs }}</script>

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script src="{% static 'js/stocks.js' %}"></script>
<style>
    .accordion-button {
        width: 100%;
        text-align: left;
        background-color: #f1f1f1;
        border: none;
        outline: none;
        padding: 18px;
        font-size: 15px;
        transition: 0.4s;
        cursor: pointer;
        display: block;
        border-bottom: 1px solid #ddd;
        border-radius: 0; /* Remove rounding */
    }

    .accordion-button:hover,
    .accordion-button:focus {
        background-color: #ccc;
    }

    .accordion-content {
        display: none;
        padding: 18px;
        background-color: white;
        border-top: none;
        overflow: hidden;
    }

    .toggle-container {
        margin-bottom: 20px;
    }

    .column-toggles {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 10px;
    }

    .column-toggles .toggle {
        display: flex;
        align-items: center;
    }

    .column-toggles label {
        margin-left: 5px;
    }

    .main-content {
        display: flex;
        justify-content: space-between;
    }

    .left-half {
        width: 48%;
    }

    .right-half {
        width: 48%;
    }

    #company-overview {
        max-height: 400px;
        overflow-y: auto;
    }

    #chart, #earnings-chart {
        max-height: 400px;
    }

    .news-section {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
    }

    .news-item {
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 8px;
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .news-item img {
        max-width: 100%;
        height: auto;
        border-radius: 4px;
    }

    .news-item h3 {
        margin-top: 10px;
        font-size: 1.2em;
    }

    .news-item p {
        margin: 10px 0;
    }

    .sentiment {
        display: flex;
        align-items: center;
    }

    .sentiment-label {
        font-weight: bold;
    }

    .sentiment-tag {
        margin-left: 5px;
        padding: 2px 8px;
        border-radius: 12px;
        color: #fff;
    }

    .sentiment-tag.bullish {
        background-color: #4caf50;
    }

    .sentiment-tag.somewhat-bullish {
        background-color: #8bc34a;
    }

    .sentiment-tag.neutral {
        background-color: #ffeb3b;
        color: #000;
    }

    .sentiment-tag.somewhat-bearish {
        background-color: #ff9800;
    }

    .sentiment-tag.bearish {
        background-color: #f44336;
    }
</style>
{% endblock %}
